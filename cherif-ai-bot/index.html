<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Real Estate GPT</title>

<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css"/>
<script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>

<!-- Stripe -->
<script src="https://js.stripe.com/v3/"></script>

<style>
  :root{
    --bg:#0b0b0c; --panel:#121214; --panel2:#141416; --text:#f3f2ee; --muted:#b9b8b3;
    --brand:#70d6ff; --line:#232326; --bubble:#1a1b1f; --bubbleUser:#23242a;
    --sidebar-w:320px; --input-h:66px; --focus:#9de6ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text);
    background:var(--bg);
    /* --- updated: add cubes texture layer --- */
    background-image:
      url('https://www.transparenttextures.com/patterns/cubes.png'),
      radial-gradient(circle at 25px 25px, rgba(255,255,255,0.04) 1px, transparent 1px),
      radial-gradient(circle at 55px 55px, rgba(255,255,255,0.03) 1px, transparent 1px);
    background-size:auto, 80px 80px, 80px 80px;
    background-position:0 0, 0 0, 40px 40px;
    background-repeat:repeat, repeat, repeat;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  /* --- optional: ensure landing + chat areas show texture even if separated --- */
  .landing,
  .chat{
    background:transparent; /* inherits body pattern */
  }

  /* --- optional: inside scrolling messages pane keep same pattern --- */
  .msgs{
    background:rgba(0,0,0,0); /* transparent so body pattern shows through */
  }
  /* If you want a slight overlay behind bubbles uncomment:
  .msgs::before{
    content:'';
    position:fixed;
    inset:0;
    pointer-events:none;
    background:rgba(11,11,12,0.35);
    z-index:-1;
  }
  */
  /* TOPBAR */
  .topbar{
    height:54px; padding:0 10px; display:flex; align-items:center; justify-content:space-between;
    background:var(--panel2); border-bottom:1px solid var(--line); position:relative; z-index:5;
  }
  .left,.right{display:flex; align-items:center; gap:10px}
  .btn-ico{display:inline-flex; align-items:center; gap:8px; cursor:pointer; color:#eae9e4}
  .btn-ico i{opacity:.92}
  .btn-ico:hover{color:#fff}
  .title{font-weight:800; letter-spacing:.2px; cursor:pointer}
  .badge{padding:6px 10px; border:1px solid #2a2a2d; border-radius:999px; background:#0e0e10; font-size:.86rem}
  #counter{min-width:54px; text-align:center}
  #welcomeChip{display:none}

  /* LAYOUT */
  .container{flex:1; display:flex; min-height:0}
  .main{flex:1; display:flex; flex-direction:column; min-height:0; transition:margin-right .18s}
  body.sidebar-open .main{ margin-right: var(--sidebar-w); }
  .side{ position:fixed; right:0; top:54px; height:calc(100% - 54px); width:var(--sidebar-w);
         background:var(--panel); border-left:1px solid var(--line); padding:12px; display:none; flex-direction:column; gap:10px; z-index:4 }
  .side.show{display:flex}
  .side h4{margin:4px 0 6px}
  .side ul{list-style:none; margin:0; padding:0}
  .side li{ padding:9px 8px; border-bottom:1px solid #222; color:#e6e5df; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  .side li:hover{background:#17181b}
  .chip-action{color:var(--brand); font-size:.92rem}
  .plans-link{ margin-top:auto; text-align:center; padding:10px; color:var(--brand); border:1px solid #222; border-radius:10px; background:#0f1013; cursor:pointer }

  /* LANDING */
  .landing{flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; gap:10px}
  .logo{font-size:2.8rem; font-weight:900}
  .tag{color:#cfcfca; letter-spacing:.2px}
  .cta{padding:12px 24px; border-radius:12px; border:1px solid #222; background:#17181b; color:var(--text); cursor:pointer}
  .ext{display:flex; gap:12px; margin-top:12px}
  .ext a{padding:8px 12px; background:#101115; border-radius:8px; color:#7ed9ff; text-decoration:none}

  /* CHAT */
  .chat{flex:1; display:none; flex-direction:column; min-height:0}
  .msgs{flex:1; overflow:auto; padding:16px 16px calc(var(--input-h) + 14px); display:flex; flex-direction:column; gap:14px}
  .bubble{max-width:min(820px,82vw); padding:12px 14px; border-radius:14px; background:#1b1c21; border:1px solid #26272c; line-height:1.45; word-wrap:break-word; overflow-wrap:anywhere}
  .bubble.user{align-self:flex-end; background:var(--bubbleUser)}
  .bubble.bot{align-self:flex-start}
  .bubble.streaming{padding:10px 12px; display:inline-flex; align-items:center; gap:10px}
  .dot{width:14px;height:14px;border-radius:50%;background:var(--brand);opacity:.85;animation:pulse .9s infinite ease-in-out}
  @keyframes pulse{0%{transform:scale(1);opacity:.6}50%{transform:scale(1.22);opacity:1}100%{transform:scale(1);opacity:.65}}

  /* INPUT */
  .input{ position:fixed; left:0; right:0; bottom:0; background:var(--panel2); border-top:1px solid var(--line);
          padding:10px 10px calc(10px + env(safe-area-inset-bottom)); z-index:6; transition:right .18s; display:none }
  body.sidebar-open .input{ right: var(--sidebar-w); }
  .attach{ display:none; gap:6px; flex-wrap:wrap; max-height:64px; overflow:auto; margin-bottom:6px }
  .attach.show{display:flex}
  .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; background:#131419; border:1px solid #2c2e33; border-radius:999px; font-size:.9rem}
  .chip .x{cursor:pointer; opacity:.8}
  .row{display:flex; align-items:center; gap:10px}
  .row input[type="text"]{flex:1; padding:12px; border-radius:12px; border:1px solid #2a2b30; background:#121319; color:var(--text); outline-color:var(--focus)}
  .icon-btn{ width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center; border-radius:12px; background:#14151a; border:1px solid #2a2a2e; color:#e9e8e3; }
  .send{ padding:12px 18px; border:none; border-radius:12px; background:#262830; color:#fff; cursor:pointer }
  .send:hover{background:#2c2f38}
  .send:disabled{opacity:.5; cursor:not-allowed}

  /* MODALS */
  .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.58); z-index:10; align-items:center; justify-content:center }
  .card{ width:min(92vw, 560px); background:rgba(18,19,24,.96); border:1px solid #27282e; border-radius:16px; padding:22px; color:#fff; backdrop-filter:blur(10px) }
  .x{ position:absolute; right:12px; top:10px; cursor:pointer; opacity:.85; font-size:22px }

  /* TOAST */
  #toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:20; background:#14151a; color:#fff; padding:10px 14px; border:1px solid #2b2c31; border-radius:10px; display:none }

  /* small */
  @media (max-width: 900px){
    body.sidebar-open .main{ margin-right:0 }
    .side{ width:min(92vw, 420px) }
  }

  /* Ripple */
  .ripple-effect {
    position: absolute;
    border-radius: 50%;
    background: rgba(127,225,255,0.25);
    transform: scale(0);
    animation: ripple .5s linear;
    pointer-events:none;
    z-index:2;
    width:100px;
    height:100px;
    left:50%;
    top:50%;
    margin-left:-50px;
    margin-top:-50px;
  }
  @keyframes ripple { to { transform: scale(2.5); opacity: 0; } }
  .ripple { position: relative; overflow: hidden; }

  /* Scrollable plans modal card */
  #plans .card{ max-height:86vh; overflow:auto; scrollbar-width:thin; }
  #plans .card::-webkit-scrollbar{ width:8px; }
  #plans .card::-webkit-scrollbar-track{ background:rgba(255,255,255,0.05); }
  #plans .card::-webkit-scrollbar-thumb{ background:#2c2f36; border-radius:6px; }

  /* --- scrollable saved chats --- */
  #historyList{
    max-height:calc(100vh - 140px); /* adjust offset if header/footer height changes */
    overflow-y:auto;
    overscroll-behavior:contain;
    padding-right:4px;
    scrollbar-width:thin;
  }
  #historyList::-webkit-scrollbar{width:8px}
  #historyList::-webkit-scrollbar-track{background:transparent}
  #historyList::-webkit-scrollbar-thumb{background:#2b2f35;border-radius:4px}
  #historyList::-webkit-scrollbar-thumb:hover{background:#3a4047}

  /* --- simple 3â€‘dot menu for history items --- */
  .history-item{position:relative; padding-right:34px}
  .history-dots{
    cursor:pointer; padding:2px 8px; font-weight:700; opacity:.7; user-select:none;
    border-radius:6px;
  }
  .history-dots:hover{opacity:1; background:#1a1b20}
  .history-popup{
    position:absolute; top:34px; right:4px; min-width:130px;
    background:#181a1f; border:1px solid #2a2c31; border-radius:10px;
    display:none; flex-direction:column; padding:4px 0; z-index:50;
    box-shadow:0 8px 26px -6px rgba(0,0,0,.55);
  }
  .history-popup.show{display:flex}
  .history-popup div{
    padding:8px 14px; font-size:.8rem; cursor:pointer; letter-spacing:.3px;
  }
  .history-popup div:hover{background:#23252b}
  .history-popup div.delete{color:#ff7d7d}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="left">
    <div class="title" onclick="goHome()">Real Estate GPT</div>
    <span id="welcomeChip" class="badge"></span>
  </div>
  <div class="right">
    <span id="planBadge" class="badge">Current plan: <b>NONE</b></span>
    <span id="counter" class="badge">3/3</span>
    <span class="btn-ico" onclick="openPlansPopup()" title="View plans"><i class="fa-regular fa-credit-card"></i></span>
    <span class="btn-ico" onclick="openAccount()" title="Account"><i class="fa-regular fa-user"></i></span>
    <span class="btn-ico" onclick="toggleSidebar()" title="History"><i class="fa-solid fa-bars"></i></span>
  </div>
</div>

<div class="container">
  <!-- SIDE / HISTORY -->
  <div id="side" class="side">
    <h4 style="display:flex;justify-content:space-between;align-items:center;margin:0;">
      Previous Chats <span class="chip-action" onclick="newChat()">+ New Chat</span>
    </h4>
    <ul id="historyList" style="margin-top:8px"></ul>
    <div class="plans-link ripple" onclick="openPlansPopup()" style="position:relative;">
      <i class="fa-regular fa-credit-card"></i> View Plans
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <!-- LANDING -->
    <div id="landing" class="landing">
      <div class="logo">Real Estate GPT</div>
      <div class="tag">OpenAI intelligence infused with Cherif Medawar's real estate knowledge</div>
      <button class="cta" onclick="startChat()">Start Chatting</button>
      <div class="ext">
        <a target="_blank" href="https://www.cherifmedawar.com/about-us/">About Cherif</a>
        <a target="_blank" href="https://cmrei.com">Visit CMREI</a>
        <a target="_blank" href="https://form.jotform.com/222204088428049">CRE Test</a>
        </div>
        <div class="tag">OpenAI</div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="chat">
      <div id="msgs" class="msgs"></div>
    </div>
  </div>
</div>

<!-- INPUT BAR -->
<div id="input" class="input">
  <div id="attachBar" class="attach"></div>
  <div class="row">
    <label class="icon-btn ripple" title="Attach files">
      <input id="fileInput" type="file" multiple accept=".pdf,.doc,.docx,.txt,.csv,.xlsx,.xls,image/*,application/*" style="display:none"/>
      <i class="fa-solid fa-paperclip"></i>
    </label>
    <input id="q" type="text" placeholder="Ask Cherifâ€¦" />
    <button id="sendBtn" class="send ripple">Send</button>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="loginModal" class="modal" aria-hidden="true">
  <div class="card" style="position:relative">
    <span class="x" onclick="closeLogin()">Ã—</span>
    <h3 id="loginTitle" style="margin:0 0 10px">Sign In</h3>
    <div id="firebaseui-auth-container"></div>
    <div id="firebaseui-auth-spinner" style="display:none">Loadingâ€¦</div>
  </div>
</div>

<!-- PLANS / BILLING MODAL -->
<div id="plans" class="modal" aria-hidden="true">
  <div class="card" style="position:relative">
    <span class="x" onclick="closePlans()">Ã—</span>
    <h2 style="margin:0 0 8px">Choose Your Plan</h2>
    <div style="color:#d5d4ce;margin-bottom:8px">Pro â€” Unlimited Q&A</div>
    <div style="font-size:2rem;font-weight:800;margin:6px 0 12px">$4.99 <span style="font-size:1rem;font-weight:600;opacity:.85">/ month</span></div>

    <div style="display:flex;gap:10px;flex-direction:column;margin-bottom:10px;color:#e8e7e2">
      <div><i class="fa-regular fa-circle-check" style="color:#7fe1ff"></i> GPT-powered answers any real estate</div>
      <div><i class="fa-regular fa-circle-check" style="color:#7fe1ff"></i> Unlimited messages & file analysis</div>
      <div><i class="fa-regular fa-circle-check" style="color:#7fe1ff"></i> Assistance with contract writing</div> 
      <div><i class="fa-regular fa-circle-check" style="color:#7fe1ff"></i> Cancel Anytime</div>
    </div>

    <div id="pf-email" style="color:#bdbbb4;margin:6px 0"></div>
    <div id="pf-card"  style="color:#bdbbb4;margin:2px 0"></div>
    <div id="pf-renew" style="color:#bdbbb4;margin:2px 0 10px"></div>

    <div id="cardWrap" style="display:block;border:1px solid #2a2b31;border-radius:12px;padding:14px;background:#111318;margin-bottom:10px">
      <div id="payment-element" style="margin:12px 0;"></div>
      <button id="purchaseBtn" type="button" class="send ripple" style="background:#79defe;color:#04232d">Subscribe</button>
      <div id="billingMsg" style="margin-top:8px;font-size:.9rem;"></div>
    </div>


  

    <div id="billMsg" style="margin-top:10px;color:#e7e6df"></div>
  </div>
</div>

<!-- ACCOUNT MODAL -->
<div id="account" class="modal" aria-hidden="true">
  <div class="card" style="position:relative">
    <span class="x" onclick="closeAccount()">Ã—</span>
    <h3 style="margin:0 0 10px">Account</h3>
    <div style="display:flex;align-items:center;gap:12px">
      <div id="acctAvatar" class="badge" style="width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800">U</div>
      <div>
        <div id="acctName" style="font-weight:700">â€”</div>
        <div id="acctEmail" style="color:#bdbbb4;font-size:.95rem">â€”</div>
      </div>
    </div>
    <div class="badge" id="acctPlan" style="display:inline-block;margin-top:10px">Plan: NONE</div>
    <div class="badge" id="acctCredits" style="display:inline-block;margin-top:10px">Credits: 3/3</div>
    <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="send" style="background:#15171d;border:1px solid #2a2b31" onclick="openPlansPopup()">Manage Plan</button>
      <button class="send" onclick="confirmLogout()">Logout</button>
    </div>
  </div>
</div>

<!-- CANCEL CONFIRM -->
<div id="cancelConfirm" class="modal" aria-hidden="true">
  <div class="card">
    <h3 style="margin:0 0 8px">Cancel subscription?</h3>
    <p style="margin:0 0 14px;color:#d9d7d1">Itâ€™ll remain active until period end.</p>
    <div style="display:flex;gap:10px">
      <button id="confirmCancelYes" class="send" style="background:#79defe;color:#04232d">Yes, cancel</button>
      <button id="confirmCancelNo"  class="send" style="background:#15171d;border:1px solid #2a2b31">Keep</button>
    </div>
  </div>
</div>

<!-- LOGOUT CONFIRM -->
<div id="logoutConfirm" class="modal" aria-hidden="true">
  <div class="card">
    <h3 style="margin:0 0 8px">Log out?</h3>
    <p style="margin:0 0 14px;color:#d9d7d1">Local view on this device will clear.</p>
    <div style="display:flex;gap:10px">
      <button class="send" onclick="doLogout()">Yes, log out</button>
      <button class="send" style="background:#15171d;border:1px solid #2a2b31" onclick="closeLogoutConfirm()">Cancel</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- WELCOME MODAL -->
<div id="welcomeModal" class="modal" aria-hidden="true">
  <div class="card" style="position:relative;text-align:center">
    <h2 id="welcomeMsg" style="margin:0 0 10px"></h2>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyALyzHcHMfYCCbF2eqinV7XlfOGJCDin4U",
  authDomain: "realestategpt-ai.firebaseapp.com",
  projectId: "realestategpt-ai",
  storageBucket: "realestategpt-ai.firebasestorage.app",
  messagingSenderId: "822449246072",
  appId: "1:822449246072:web:82c572361d8455fd52c28d",
  measurementId: "G-W3E8Q2YKZL"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

const API_BASE = '/api';
const STREAM_TIMEOUT_MS = 60000;

/* ---------- TOAST ---------- */
function toast(txt, ms=2200){ const t=document.getElementById('toast'); t.textContent=txt; t.style.display='block'; setTimeout(()=>t.style.display='none', ms); }

/* ---------- UI helpers ---------- */
function show(el){ el.style.display='flex'; }
function hide(el){ el.style.display='none'; }
function toggleSidebar(){
  const s=document.getElementById('side');
  const open = s.classList.toggle('show');
  document.body.classList.toggle('sidebar-open', open);
}
function goHome(){
  document.getElementById('landing').style.display='flex';
  document.getElementById('chat').style.display='none';
  const s=document.getElementById('side'); if(s){ s.classList.remove('show'); }
  document.body.classList.remove('sidebar-open');
  document.getElementById('input').style.display='none';
}
function startChat(){
  document.getElementById('landing').style.display='none';
  document.getElementById('chat').style.display='flex';
  if(window.innerWidth >= 900){
    const s=document.getElementById('side'); if(s){ s.classList.add('show'); }
    document.body.classList.add('sidebar-open');
  } else {
    const s=document.getElementById('side'); if(s){ s.classList.remove('show'); }
    document.body.classList.remove('sidebar-open');
  }
  document.getElementById('input').style.display='block';
}
window.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('input').style.display='none'; });

/* ---------- MODALS ---------- */
function openLogin(title='Sign In'){
  document.getElementById('loginTitle').textContent=title;
  show(document.getElementById('loginModal'));
  if(!window._ui){ window._ui=new firebaseui.auth.AuthUI(auth); }
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
  window._ui.start('#firebaseui-auth-container',{
    signInFlow:'popup',
    signInOptions:[firebase.auth.GoogleAuthProvider.PROVIDER_ID],
    callbacks:{signInSuccessWithAuthResult:()=>{ closeLogin(); return false; }}
  });
}
function closeLogin(){ hide(document.getElementById('loginModal')); if(window._ui){ try{_ui.reset();}catch{} } }
function openPlansPopup(){ ensureSignedIn(async ()=>{ await loadBillingFacts(); show(document.getElementById('plans')); }); }
async function loadBillingFacts(){
  const u=auth.currentUser; if(!u) return;
  try{
    const r=await fetch('/api/billing/status',{method:'POST',headers:{'Content-Type':'application/json','X-User-Id':u.uid,'X-User-Email':u.email||''}});
    if(!r.ok) return;
    const d=await r.json();
    const emailEl=document.getElementById('pf-email');
    const cardEl =document.getElementById('pf-card');
    const renewEl=document.getElementById('pf-renew');
    if(emailEl) emailEl.textContent=d.email?`Signed in as: ${d.email}`:'';
    if(cardEl){
      if(d.default_payment_method){ const c=d.default_payment_method; cardEl.textContent=`Card: ${(c.brand||'CARD').toUpperCase()} â€¢â€¢â€¢â€¢ ${c.last4}`; }
      else cardEl.textContent='No card on file.';
    }
    if(renewEl){ renewEl.textContent = d.active && d.renews_at ? `Renews on ${new Date(d.renews_at*1000).toLocaleDateString()}` : ''; }
    if(String(d.plan||'none').toUpperCase()==='PRO'){ setPlan('PRO'); }
  }catch(e){ console.warn('loadBillingFacts error', e); }
}
function closePlans(){ hide(document.getElementById('plans')); }
function openAccount(){
  const u=auth.currentUser; if(!u) return openLogin('Login');
  document.getElementById('acctAvatar').textContent=(u.displayName||u.email||'U').slice(0,1).toUpperCase();
  document.getElementById('acctName').textContent=u.displayName||'User';
  document.getElementById('acctEmail').textContent=u.email||'â€”';
  document.getElementById('acctPlan').textContent=`Plan: ${getPlan()}`;
  document.getElementById('acctCredits').textContent=`Credits: ${getPlan()==='NONE'?getCredits()+"/3":"âˆž"}`;
  show(document.getElementById('account'));
}
function closeAccount(){ hide(document.getElementById('account')); }
function confirmLogout(){ show(document.getElementById('logoutConfirm')); }
function closeLogoutConfirm(){ hide(document.getElementById('logoutConfirm')); }
function openCancel(){ show(document.getElementById('cancelConfirm')); }
function closeCancel(){ hide(document.getElementById('cancelConfirm')); }

/* ---------- Per-user local state ---------- */
function planKey(uid){return `plan:${uid}`}
function creditsKey(uid){return `credits:${uid}`}
function resetKey(uid){return `creditsResetAt:${uid}`}

function ensureUserState(uid){
  if(!localStorage.getItem(planKey(uid))) localStorage.setItem(planKey(uid),'NONE');
  if(!localStorage.getItem(creditsKey(uid))) localStorage.setItem(creditsKey(uid),'3');
  let r=localStorage.getItem(resetKey(uid));
  if(!r){ localStorage.setItem(resetKey(uid), new Date(Date.now()+7*864e5).toISOString()); }
  else if(Date.now()>Date.parse(r)){ localStorage.setItem(creditsKey(uid),'3'); localStorage.setItem(resetKey(uid), new Date(Date.now()+7*864e5).toISOString()); }
}
function getPlan(){ const u=auth.currentUser; if(!u) return 'NONE'; return localStorage.getItem(planKey(u.uid))||'NONE'; }
function setPlan(p){ const u=auth.currentUser; if(!u) return; localStorage.setItem(planKey(u.uid), p); updateTop(); }
function getCredits(){ const u=auth.currentUser; if(!u) return 0; return parseInt(localStorage.getItem(creditsKey(u.uid))||'3',10); }
function spendCredit(){ if(getPlan()!=='NONE') return; const u=auth.currentUser; if(!u) return; const c=Math.max(0, getCredits()-1); localStorage.setItem(creditsKey(u.uid), String(c)); updateTop(); }
function canSpend(){ return getPlan()!=='NONE' || getCredits()>0; }

function updateTop(){
  const b=document.getElementById('planBadge'), c=document.getElementById('counter');
  const p=getPlan();
  b.innerHTML=`Current plan: <b>${p}</b>`;
  c.textContent=p==='NONE'?`${getCredits()}/3`:'âˆž';
  if(p==='NONE'){
    const u=auth.currentUser;
    if(u){
      const resetAt = localStorage.getItem(resetKey(u.uid));
      if(resetAt){
        const ms = Date.parse(resetAt) - Date.now();
        if(ms > 0){
          const days = Math.floor(ms/86400000), hrs = Math.floor((ms%86400000)/3600000);
          c.title = `Resets in ${days}d ${hrs}h`;
        }
      }
    }
  }
}

/* ---------- Welcome chip ---------- */
function welcome(){
  const u=auth.currentUser; if(!u) return;
  const chip=document.getElementById('welcomeChip');
  chip.textContent=`Welcome, ${(u.displayName||u.email||'User')}`; chip.style.display='inline-block'; setTimeout(()=>{chip.style.display='none'}, 5000);
  const modal = document.getElementById('welcomeModal');
  document.getElementById('welcomeMsg').textContent = `Welcome, ${(u.displayName||u.email||'User')}!`;
  show(modal);
  setTimeout(()=>{ hide(modal); }, 2200);
}

/* ---------- AUTH + HISTORY (messages array) ---------- */
let currentUserId = null;
let currentChatId = null;

function userChatsCol(uid){
  return db.collection('users').doc(uid).collection('chats');
}

let historyUnsub = null;
function subscribeHistory(uid){
  if (historyUnsub) { try{ historyUnsub(); }catch{} }
  historyUnsub = userChatsCol(uid)
    .orderBy('updatedAt', 'desc')
    .limit(50)
    .onSnapshot((snap)=>{
      const chats = [];
      snap.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
      renderHistoryList(chats);
    }, (err)=>{
      console.warn('history listener error', err);
    });
}

function closeHistoryMenus(){
  document.querySelectorAll('.history-popup.show').forEach(p=>p.classList.remove('show'));
}

function renderHistoryList(chats){
  const ul = document.getElementById('historyList');
  if(!ul) return;
  ul.innerHTML = '';

  // New Chat
  const liNew = document.createElement('li');
  liNew.className='history-item';
  liNew.innerHTML = '<span style="flex:1">+ New Chat</span>';
  liNew.onclick = newChat;
  ul.appendChild(liNew);

  chats.forEach(c=>{
    const li = document.createElement('li');
    li.className='history-item';
    li.dataset.id = c.id;

    const title = document.createElement('span');
    title.style.flex='1';
    title.style.overflow='hidden';
    title.style.textOverflow='ellipsis';
    title.style.whiteSpace='nowrap';
    title.textContent = c.title || 'Untitled';

    const dots = document.createElement('span');
    dots.className='history-dots';
    dots.textContent='â€¢â€¢â€¢';

    const menu = document.createElement('div');
    menu.className='history-popup';
    menu.innerHTML = `
      <div data-act="rename">Rename</div>
      <div data-act="delete" class="delete">Delete</div>
    `;

    dots.onclick = (e)=>{
      e.stopPropagation();
      const open = menu.classList.contains('show');
      closeHistoryMenus();
      if(!open) menu.classList.add('show');
    };

    menu.onclick = async (e)=>{
      e.stopPropagation();
      const act = e.target.getAttribute('data-act');
      if(!act) return;
      menu.classList.remove('show');

      if(act==='delete'){
        if(!confirm('Delete this chat?')) return;
        try{
          await userChatsCol(currentUserId).doc(c.id).delete();
          if(currentChatId===c.id){
            currentChatId=null;
            document.getElementById('msgs').innerHTML='';
          }
        }catch(err){
          console.warn(err); toast('Delete failed');
        }
      } else if(act==='rename'){
        const current = c.title || 'Untitled';
        const nn = prompt('New title:', current);
        if(!nn) return;
        const newTitle = nn.trim().slice(0,80);
        if(!newTitle || newTitle===current) return;
        try{
          await userChatsCol(currentUserId).doc(c.id).set({
            title:newTitle,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge:true });
        }catch(err){
          console.warn(err); toast('Rename failed');
        }
      }
    };

    li.onclick = (e)=>{
      if(e.target===dots || menu.contains(e.target)) return;
      loadChat(c.id);
      if(window.innerWidth < 900){
        document.getElementById('side').classList.remove('show');
        document.body.classList.remove('sidebar-open');
      }
    };

    li.appendChild(title);
    li.appendChild(dots);
    li.appendChild(menu);
    ul.appendChild(li);
  });
}

// outside click / esc to close
document.addEventListener('click', (e)=>{
  if(!e.target.closest('.history-popup') && !e.target.closest('.history-dots')){
    closeHistoryMenus();
  }
});
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape') closeHistoryMenus();
});

/* ---------- CHAT MESSAGE HANDLING ---------- */
async function loadChat(chatId){
  if(!currentUserId) return;
  currentChatId = chatId;
  const doc = await userChatsCol(currentUserId).doc(chatId).get();
  const data = doc.data() || {};
  const msgs = Array.isArray(data.messages) ? data.messages : [];
  const pane = document.getElementById('msgs');
  pane.innerHTML = '';
  msgs.forEach(m => appendBubble(m.role, m.content));
  // show chat view/input if coming from landing
  document.getElementById('landing').style.display='none';
  document.getElementById('chat').style.display='flex';
  document.getElementById('input').style.display='block';
  scrollToBottom();
}

function newChat(){
  currentChatId = null;
  document.getElementById('msgs').innerHTML='';
  toast('New chat');
}

function appendBubble(role, text){
  const pane = document.getElementById('msgs');
  const div = document.createElement('div');
  div.className = role === 'user' ? 'bubble user' : 'bubble bot';
  div.innerHTML = role === 'user' ? escapeHtml(String(text||'')) : md(String(text||''));
  pane.appendChild(div);
}

function scrollToBottom(){ const pane=document.getElementById('msgs'); pane.scrollTop=pane.scrollHeight; }

/* ---------- Markdown helpers ---------- */
function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
function md(s){
  s = s.replace(/^### (.*)$/gm, '<h3>$1</h3>');
  s = s.replace(/^## (.*)$/gm, '<h2>$1</h2>');
  s = s.replace(/^# (.*)$/gm, '<h1>$1</h1>');
  s = s.replace(/```([\s\S]*?)```/g,(_,c)=>'<pre><code>'+escapeHtml(c)+'</code></pre>');
  s = s.replace(/`([^`]+)`/g,(_,c)=>'<code>'+escapeHtml(c)+'</code>');
  s = s.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
  s = s.replace(/\*([^*]+)\*/g,'<em>$1</em>');
  return s.split(/\n{2,}/).map(ch=>/^</.test(ch.trim())?ch:`<p>${ch.replace(/\n/g,'<br>')}</p>`).join('\n');
}

function typeOutAnswer(el, full){
  const chars = [...String(full||'')];
  if(!chars.length){ el.innerHTML='[no answer]'; return; }
  let i=0, buffer='';

  function liveRender(){
    const txt = buffer;
    // count code fences
    const fences = (txt.match(/```/g)||[]).length;
    if(fences % 2 === 1){
      // inside an unfinished code block
      const openIdx = txt.lastIndexOf('```');
      const closedPart = txt.slice(0, openIdx);
      const openPart = txt.slice(openIdx + 3);
      el.innerHTML = md(closedPart) + '<pre><code>'+escapeHtml(openPart)+'</code></pre>';
    } else {
      el.innerHTML = md(txt);
    }
    scrollToBottom();
  }

  function step(){
    if(i < chars.length){
      buffer += chars[i++];
      // render on every char that ends a word-ish unit or every few chars
      if(i % 2 === 1 || /[\s\.\!\?]/.test(buffer[buffer.length-1])){
        liveRender();
      }
      setTimeout(step, 15); // typing speed
    } else {
      liveRender(); // final render (ensures full markdown)
    }
  }
  step();
}

/* ---------- Uploads (unchanged UI; expects /api/upload) ---------- */
const attachBar=document.getElementById('attachBar'); const fileInput=document.getElementById('fileInput');
let selectedNames=[]; let uploaded=[];

function refreshAttach(){
  attachBar.innerHTML=''; if(selectedNames.length===0){ attachBar.classList.remove('show'); return; }
  selectedNames.forEach((nm,idx)=>{ const chip=document.createElement('span'); chip.className='chip'; chip.textContent=nm; const x=document.createElement('span'); x.className='x'; x.textContent='âœ–'; x.onclick=()=>{ selectedNames.splice(idx,1); uploaded = uploaded.filter(f=>f.name!==nm); refreshAttach(); }; chip.appendChild(x); attachBar.appendChild(chip); });
  attachBar.classList.add('show');
}
fileInput.addEventListener('change', async (e)=>{
  const files=Array.from(e.target.files||[]); if(!files.length) return;
  const room=Math.max(0, 10-selectedNames.length);
  const take=files.slice(0,room);
  selectedNames.push(...take.map(f=>f.name)); refreshAttach();
  try{
    const form=new FormData(); take.forEach(f=>form.append('files',f,f.name));
    const u=auth.currentUser; const headers={}; if(u){ headers['X-User-Id']=u.uid; headers['X-User-Plan']=getPlan().toLowerCase(); }
    const res=await fetch(`${API_BASE}/upload`,{method:'POST',body:form,headers});
    const data=await res.json(); uploaded.push(...(data.files||[]));
    (data.files||[]).forEach(f=>{
      appendBubble('bot', `ðŸ“„ <strong>${escapeHtml(f.name)}</strong> uploaded.`);
    });
    toast(`${(data.files||[]).length} file(s) ready`);
  }catch{ toast('Upload failed'); } finally{ fileInput.value=''; }
});

/* ---------- SEND MESSAGE: create chat on first message ---------- */
async function ask(){
  const u=auth.currentUser;
  if(!u){ openLogin('Login required'); return; }
  if(getPlan()==='NONE' && getCredits()<=0){
    toast('Free weekly limit reached');
    openPlansPopup();
    setTimeout(()=>{ document.getElementById('plans').focus(); }, 200);
    return;
  }
  const qEl=document.getElementById('q');
  const text=(qEl.value||'').trim();
  if(!text) return;

  // UI: show chat view
  document.getElementById('landing').style.display='none';
  document.getElementById('chat').style.display='flex';
  document.getElementById('input').style.display='block';

  qEl.value='';
  const sendBtn=document.getElementById('sendBtn'); sendBtn.disabled=true;

  appendBubble('user', text);
  if(selectedNames.length){
    appendBubble('bot', `<strong>Attachments:</strong><ul>${selectedNames.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}</ul>`);
  }

  const headers={'Content-Type':'application/json','X-User-Id':u.uid};
  const payload={ question: text };
  if (currentChatId) payload.chatId = currentChatId;
  if (uploaded.length) payload.files = uploaded.slice(0,10);

  const botElId=`m${Date.now()}`;
  const streamEl = document.createElement('div');
  streamEl.className='bubble bot streaming';
  streamEl.id = botElId;
  streamEl.innerHTML = '<span class="dot"></span>';
  document.getElementById('msgs').appendChild(streamEl);
  scrollToBottom();

  try{
    const ctl=new AbortController();
    const t=setTimeout(()=>ctl.abort(), STREAM_TIMEOUT_MS);
    const r=await fetch(`${API_BASE}/ask`,{method:'POST',headers,body:JSON.stringify(payload),signal:ctl.signal});
    clearTimeout(t);

    const data = await r.json().catch(()=>({ error:'Invalid JSON' }));
    if(!r.ok){
      streamEl.classList.remove('streaming');
      streamEl.textContent = data && data.error ? data.error : `Server error (${r.status})`;
      toast('Backend error');
      return;
    }

    // On first message, backend returns the new chatId
    if(!currentChatId && data.chatId){ currentChatId = data.chatId; }

    // render assistant with typing
    streamEl.classList.remove('streaming');
    streamEl.innerHTML='';            // clear spinner
    typeOutAnswer(streamEl, data.answer||'[no answer]');
    scrollToBottom();

    // update credits for free plan
    if(getPlan()==='NONE'){ spendCredit(); }

  }catch(err){
    console.error('ask error', err);
    streamEl.classList.remove('streaming');
    streamEl.textContent='Network/timeout when calling /api/ask';
    toast('Network error');
  }finally{
    selectedNames=[]; uploaded=[]; refreshAttach();
    sendBtn.disabled=false;
  }
}

/* ---------- Stripe Billing ---------- */
async function cancelSub(){
  const u=auth.currentUser; if(!u) return;
  const r=await fetch(`${API_BASE}/billing/cancel`,{
    method:'POST',
    headers:{'Content-Type':'application/json','X-User-Id':u.uid,'X-User-Email':u.email||''}
  });
  if(!r.ok){
    const d=await r.json().catch(()=>({})); 
    document.getElementById('billMsg').textContent = d.detail || 'Cancel failed.';
  }else{
    document.getElementById('billMsg').textContent='Will cancel at period end.';
  }
  closeCancel();
  await loadBillingFacts();
}

/* ---------- Auth helpers ---------- */
function ensureSignedIn(fn){ if(auth.currentUser) fn(); else openLogin('Login required'); }
async function doLogout(){ closeLogoutConfirm(); try{ await auth.signOut(); }catch{} document.getElementById('msgs').innerHTML=''; currentChatId=null; renderHistoryList([]); updateTop(); toast('Logged out'); }

/* ---------- Welcome chip on first load ---------- */
updateTop();

/* ---------- Auth state to wire history ---------- */
auth.onAuthStateChanged(async (u)=>{
  if(u){
    currentUserId = u.uid;
    ensureUserState(u.uid);
    updateTop(); welcome();
    subscribeHistory(u.uid);
  }else{
    currentUserId = null;
    currentChatId = null;
    document.getElementById('historyList').innerHTML='';
    updateTop();
  }
});

/* ---------- Wire send button + Enter key ---------- */
document.getElementById('sendBtn').addEventListener('click', ask);
document.getElementById('q').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(); }
});
</script>

<script>
// Stripe purchase flow (no redirect)
let stripe, elements, paymentEl, clientSecret, paymentIntentId;
const btn = document.getElementById('purchaseBtn');
const msg = document.getElementById('billingMsg');

function toastBilling(t,bad=false){
  if(msg){ msg.textContent=t; msg.style.color = bad? '#ff6b6b':'#6be07a'; }
}
function busy(b, text){
  if(btn){
    btn.disabled = b;
    btn.textContent = b ? (text || 'Processingâ€¦') : 'Subscribe';
  }
}

async function initStripeClient(){
  try{
    const cfg = await (await fetch('/api/billing/config')).json();
    if(!cfg.publishableKey) throw new Error('Missing publishable key');
    stripe = Stripe(cfg.publishableKey);
    // create intent (needs user headers for metadata)
    const u = firebase.auth().currentUser;
    if(!u){ toastBilling('Login required', true); return; }

    const subResp = await fetch('/api/billing/subscribe',{
      method:'POST',
      headers:{
        'X-User-Id': u.uid,
        'X-User-Email': u.email || ''
      }
    });

    const raw = await subResp.text();
    let sub;
    try{
      sub = JSON.parse(raw);
    }catch(parseErr){
      toastBilling('Error: ' + raw, true);
      return;
    }

    if(!subResp.ok){
      toastBilling(sub.error || 'Subscription init failed', true);
      return;
    }
    if(!sub.clientSecret){
      toastBilling('No clientSecret returned', true);
      return;
    }

    clientSecret = sub.clientSecret;
    paymentIntentId = sub.paymentIntentId;
    elements = stripe.elements({ clientSecret });
    paymentEl = elements.create('payment');
    paymentEl.mount('#payment-element');
    btn.removeEventListener('click', onPurchaseStripe);
    btn.addEventListener('click', onPurchaseStripe);
    toastBilling('Enter card then press Subscribe.');
  }catch(e){
    console.error(e);
    toastBilling(e.message || 'Stripe init failed', true);
  }
}

async function onPurchaseStripe(){
  busy(true,'Confirmingâ€¦');
  try{
    await elements.submit(); // validate fields
    const { error } = await stripe.confirmPayment({
      elements,
      clientSecret,
      redirect: 'if_required'
    });
    if (error) throw error;

    // Activate plan server-side
    const u = firebase.auth().currentUser;
    if(u){
      const act = await fetch('/api/billing/activate',{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          'X-User-Id': u.uid,
          'X-User-Email': u.email || ''
        },
        body: JSON.stringify({ paymentIntentId })
      });
      const actData = await act.json();
      if(!act.ok) throw new Error(actData.error || 'Activation failed');
      // Update local plan immediately
      setPlan('PRO');
      toastBilling('Payment complete. Pro unlocked ðŸŽ‰');
      updateTop();
      loadBillingFacts().catch(()=>{});
    } else {
      toastBilling('Reload after login.', true);
    }
    busy(false);
  }catch(e){
    console.error(e);
    toastBilling(e.message || 'Stripe error', true);
    busy(false);
  }
}

// Re-init Stripe each time plans modal opens (fresh intent if needed)
const origOpenPlans = window.openPlansPopup;
window.openPlansPopup = function(){
  origOpenPlans && origOpenPlans();
  setTimeout(()=>{ initStripeClient(); }, 100); // delay so modal is visible
};
</script>
</body>
</html>
